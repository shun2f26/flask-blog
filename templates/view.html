{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- moment.jsのロード（Flaskでjinja2-momentを使用している前提） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ja.min.js"></script>
<script>
    moment.locale('ja');
</script>

<div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">

    <!-- 記事コンテナ -->
    <article class="bg-white shadow-2xl rounded-2xl p-6 sm:p-10 transition duration-300 hover:shadow-3xl">
        
        <!-- 記事タイトル -->
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-4xl font-extrabold text-gray-900 leading-tight mb-4">
                {{ post.title }}
            </h1>
            <!-- 記事メタ情報 -->
            <div class="flex flex-wrap items-center text-sm text-gray-500 space-x-3">
                <span class="mb-1"><i class="fas fa-user mr-1 text-primary"></i> 投稿者: {{ post.author.username }}</span>
                <span class="hidden sm:inline">|</span>
                <span class="mb-1"><i class="fas fa-clock mr-1 text-primary"></i> 投稿日時: {{ moment(post.timestamp).format('LL') }}</span>
            </div>
        </header>

        <!-- 画像/動画表示エリア (Optional) -->
        <div class="mb-8">
            {% if post.image_url %}
            <figure class="rounded-xl overflow-hidden shadow-lg border border-gray-100">
                <!-- URL for image should be generated via url_for('static', filename=...) if files are served from static folder -->
                <img src="{{ url_for('static', filename=post.image_url) }}" alt="{{ post.title }}の画像" class="w-full h-auto object-cover max-h-96">
                <figcaption class="p-2 text-sm text-gray-600 text-center bg-gray-50 border-t border-gray-100">メイン画像</figcaption>
            </figure>
            {% elif post.video_url %}
            <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-xl shadow-lg border border-gray-100">
                <!-- 16:9のアスペクト比を維持 -->
                <!-- URL for video should be generated via url_for('static', filename=...) -->
                <video controls class="absolute top-0 left-0 w-full h-full object-cover bg-black">
                    <source src="{{ url_for('static', filename=post.video_url) }}" type="video/mp4">
                    申し訳ありませんが、お使いのブラウザは動画タグをサポートしていません。
                </video>
            </div>
            {% endif %}
        </div>

        <!-- 記事本文 -->
        <section class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
            <!-- post.content はMarkdownなどで記述されていることを想定し、
                 Flask側でHTMLに変換された安全な内容として | safe を使用します。 -->
            {{ post.content | safe }} 
        </section>

        <!-- 編集・削除ボタン (認証・権限チェック) -->
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.user_id) %}
        <footer class="mt-10 pt-6 border-t border-gray-200 flex justify-end space-x-4">
            
            <!-- 編集ボタン -->
            <!-- 修正点: post_id を _id に変更 -->
            <a href="{{ url_for('edit_post', _id=post.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 transform hover:scale-105">
                <i class="fas fa-edit mr-2"></i>
                記事を編集
            </a>
            
            <!-- 削除ボタン (モーダルをトリガー) -->
            <button onclick="document.getElementById('delete-modal').classList.remove('hidden')" 
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-red-500 hover:bg-red-600 transition duration-150 transform hover:scale-105">
                <i class="fas fa-trash-alt mr-2"></i>
                削除
            </button>
        </footer>
        {% endif %}

    </article>

    <!-- 記事一覧へ戻るリンク -->
    <div class="mt-8 text-center">
        <a href="{{ url_for('index') }}" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition duration-150 p-3 rounded-full bg-white shadow-xl hover:shadow-2xl hover:bg-indigo-50/50">
            <i class="fas fa-arrow-circle-left text-lg mr-2"></i>
            記事一覧に戻る
        </a>
    </div>

</div>

<!-- 削除確認モーダル (alert/confirm禁止のためカスタム実装) -->
<div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[1001] flex items-center justify-center transition-opacity duration-300">
    <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl transform scale-100 transition-transform duration-300">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
            削除の確認
        </h3>
        <p class="text-gray-600 mb-6">本当にこの投稿を削除しますか？この操作は元に戻せません。</p>
        
        <div class="flex justify-end space-x-3">
            <!-- キャンセルボタン -->
            <button onclick="document.getElementById('delete-modal').classList.add('hidden')" 
                    class="px-5 py-2 border border-gray-300 rounded-full text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150 shadow-md">
                キャンセル
            </button>
            
            <!-- 削除実行ボタン (フォーム送信) -->
            <!-- 修正点: post_id を _id に変更 -->
            <form action="{{ url_for('delete_post', _id=post.id) }}" method="POST" class="inline">
                <button type="submit" class="px-5 py-2 border border-transparent rounded-full text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-lg shadow-red-200/50">
                    <i class="fas fa-trash-alt mr-1"></i>
                    完全に削除
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // モーダル外クリックで閉じる機能
    document.getElementById('delete-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
</script>

{% endblock %}
