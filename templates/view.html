{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-10 px-4">

    <!-- タイトル -->
    <h1 class="text-4xl font-bold mb-4">{{ post.title }}</h1>

    <!-- 日付 & 投稿者 -->
    <p class="text-gray-500 mb-4 flex items-center">
        <i class="fa-regular fa-calendar mr-2"></i>
        {{ post.created_at|datetimeformat }}
        <i class="fa-solid fa-user ml-4 mr-2"></i>
        {{ post.author.username }}
    </p>

    <hr class="my-4">

    <!-- 動画（優先） -->
    {% if post.video_public_id %}
    <div class="mb-6 shadow-lg rounded-xl overflow-hidden">
        <video class="w-full" controls preload="metadata" playsinline>
            <source src="{{ safe_video_url(post.video_public_id) }}" type="video/mp4">
            お使いのブラウザは動画再生に対応していません。
        </video>
    </div>

    {% elif post.image_public_id %}
    <!-- 画像 -->
    <img src="{{ get_safe_cloudinary_url(post.image_public_id, width=1000, height=600, crop='fill') }}"
         class="w-full rounded-xl shadow mb-6">
    {% endif %}

    <!-- 本文 -->
    <div class="text-lg leading-relaxed whitespace-pre-line mb-10">
        {{ post.content }}
    </div>

    <!-- コメント一覧 -->
    <h2 class="text-2xl font-bold flex items-center mb-4">
        <i class="fa-solid fa-comments text-primary mr-3"></i> コメント一覧
    </h2>

    {% if comments %}
        {% for c in comments %}
        <div class="bg-gray-50 p-4 rounded-lg shadow mb-4">
            <p class="font-semibold">{{ c.name }}</p>
            <p class="text-gray-700 whitespace-pre-line mt-1">{{ c.content }}</p>
            <p class="text-xs text-gray-500 mt-2">{{ c.created_at|datetimeformat }}</p>

            {% if current_user.is_authenticated
                and current_user.id in [c.author_id, post.user_id] %}
            <form action="{{ url_for('delete_comment', comment_id=c.id) }}" method="POST">
                <button class="text-red-500 hover:underline text-sm mt-2">削除</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}

    {% else %}
    <p class="text-gray-500 mb-10">まだコメントはありません。</p>
    {% endif %}

    <!-- コメントフォーム -->
    <h2 class="text-2xl font-bold flex items-center mt-10 mb-4">
        <i class="fa-solid fa-pen text-green-600 mr-3"></i> コメントを書く
    </h2>

    <form method="POST" action="{{ url_for('comment', post_id=post.id) }}">
        {{ form.hidden_tag() }}

        <label class="block mb-2 font-medium">名前</label>
        {{ form.name(class="w-full p-3 border rounded mb-4") }}

        <label class="block mb-2 font-medium">コメント</label>
        {{ form.content(class="w-full p-3 border rounded mb-4 h-32") }}

        <button type="submit"
                class="px-6 py-2 bg-primary text-white rounded-full shadow hover:bg-indigo-700">
            投稿
        </button>
    </form>

</div>
{% endblock %}
