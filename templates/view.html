{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>

<style>
.video-container {
  width: 100%;
  aspect-ratio: 16 / 9;
  background-color: #000;
  border-radius: 0.75rem;
  overflow: hidden;
  margin-bottom: 1.5rem;
}
.video-container video {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.image-container img {
  max-height: 500px;
  width: 100%;
  object-fit: contain;
  border-radius: 0.75rem;
  margin-bottom: 1.5rem;
}
</style>

<div class="min-h-screen bg-gray-50 py-10 px-4">
  <div class="max-w-3xl mx-auto bg-white shadow-2xl rounded-2xl p-8">

    <!-- 投稿タイトル -->
    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">{{ post.title }}</h1>

    <!-- 投稿情報 -->
    <div class="flex items-center text-sm text-gray-500 mb-6 border-b pb-4">
      <span class="mr-3">
        <i class="fas fa-calendar-alt mr-1"></i> {{ post.created_at | datetimeformat }}
      </span>
      <span>
        <i class="fas fa-user-edit mr-1"></i> {{ post.author.username }}
      </span>

      {% if current_user.is_authenticated and post.user_id == current_user.id %}
      <a
        href="{{ url_for('update', post_id=post.id) }}"
        class="ml-auto text-indigo-600 hover:text-indigo-800 font-medium"
      >
        <i class="fas fa-edit mr-1"></i> 編集
      </a>
      {% endif %}
    </div>

    <!-- メディア（動画または画像） -->
    {% if post.video_public_id %}
      <div class="video-container mb-6 shadow-lg">
        <video controls preload="metadata" playsinline crossorigin="anonymous">
          <source src="{{ get_safe_cloudinary_video_url(post.video_public_id) }}" type="video/mp4">
          お使いのブラウザは動画タグをサポートしていません。
        </video>
      </div>

      {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="flex justify-center mb-6">
        <a
          href="{{ url_for('download_video', post_id=post.id) }}"
          class="inline-flex items-center py-3 px-6 border border-transparent rounded-full shadow-lg text-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition duration-150 ease-in-out"
        >
          <i class="fas fa-download mr-2"></i> 動画をダウンロード (MP4)
        </a>
      </div>
      {% endif %}

    {% elif post.image_public_id %}
      <div class="image-container">
        <img
          src="{{ get_safe_cloudinary_url(post.image_public_id, width=800, crop='limit') }}"
          alt="{{ post.title }}"
          class="shadow-lg rounded-xl"
        />
      </div>
    {% endif %}

    <!-- 投稿本文 -->
    <div class="text-gray-700 text-lg leading-relaxed mb-10">
      {{ post.content | replace('\n', '<br>') | safe }}
    </div>

    <!-- コメント一覧 -->
    <div id="comments" class="mt-10 border-t pt-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">
        <i class="fas fa-comments mr-2 text-indigo-600"></i> コメント
      </h3>

      {% if comments %}
      <ul class="space-y-4">
        {% for comment in comments %}
        <li class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
          <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-gray-800">{{ comment.name }}</span>
            <span class="text-xs text-gray-400">{{ comment.created_at | datetimeformat }}</span>
          </div>
          <p class="text-gray-700 whitespace-pre-line">{{ comment.content }}</p>

          {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == comment.author_id or current_user.id == post.user_id) %}
          <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" class="text-right mt-2">
            <button type="submit" class="text-xs text-red-500 hover:text-red-700">
              <i class="fas fa-trash-alt mr-1"></i>削除
            </button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500">まだコメントはありません。</p>
      {% endif %}
    </div>

    <!-- コメント投稿フォーム -->
    <div class="mt-10 border-t pt-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">
        <i class="fas fa-pen mr-2 text-teal-600"></i> コメントを投稿
      </h3>

      <form action="{{ url_for('comment', post_id=post.id) }}" method="POST" class="space-y-4">
        {{ form.hidden_tag() }}

        <div>
          {{ form.name.label(class="block text-gray-700 font-medium mb-1") }}
          {{ form.name(class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500") }}
          {% for error in form.name.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.content.label(class="block text-gray-700 font-medium mb-1") }}
          {{ form.content(class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500", rows="4") }}
          {% for error in form.content.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>

        <div class="flex justify-end">
          {{ form.submit(class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-md shadow") }}
        </div>
      </form>
    </div>

  </div>
</div>
{% endblock %}
