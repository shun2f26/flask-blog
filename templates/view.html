{% macro render_media(post, width='800', height='450') %}
    {# post から Public ID とメディアタイプを判定。
       ここでは、コンテキストプロセッサで提供される関数を使用します。 #}
    {% set public_id = post.image_public_id or post.video_public_id %}
    {% set is_video = post.video_public_id is not none and post.video_public_id != '' %}

    {# コンテキストプロセッサから提供される CLOUDINARY_AVAILABLE をチェック #}
    {% if CLOUDINARY_AVAILABLE and public_id %}
        
        {# Cloudinary の最適化パラメータを定義 #}
        {% set options = {
            'width': width, 
            'height': height, 
            'crop': 'fill', 
            'gravity': 'auto', 
            'quality': 'auto', 
            'fetch_format': 'auto' 
        } %}
        
        {% if is_video %}
            {# --- 動画 (Video) の表示ロジック --- #}
            
            {# get_cloudinary_video_url を使って動画のソースURLを生成 #}
            {% set video_url = get_cloudinary_video_url(public_id, **options) %}
            
            {# サムネイル（ポスター画像）のURLを生成
               so_0: 0秒目のフレームを取得し、f_jpg: JPEG形式に変換 #}
            {% set poster_options = options | merge({'format': 'jpg', 'time_0': True}) %}
            {% set poster_url = get_cloudinary_video_url(public_id, **poster_options) %}

            <div class="media-container rounded-xl shadow-2xl overflow-hidden bg-black mx-auto" 
                 style="max-width: {{ width }}px;">
                <video 
                    controls 
                    preload="metadata"
                    width="{{ width }}" 
                    height="{{ height }}"
                    poster="{{ poster_url }}" 
                    class="w-full h-auto block"
                >
                    <source src="{{ video_url }}" type="video/mp4">
                    申し訳ありませんが、お使いのブラウザは動画をサポートしていません。
                </video>
            </div>
            
        {% else %}
            {# --- 画像 (Image) の表示ロジック --- #}
            
            {# get_cloudinary_url を使って画像URLを生成 #}
            {% set img_url = get_cloudinary_url(public_id, **options) %}
            
            <div class="media-container rounded-xl shadow-2xl overflow-hidden mx-auto"
                 style="max-width: {{ width }}px;">
                <img 
                    src="{{ img_url }}" 
                    alt="{{ post.title }} の画像" 
                    class="w-full h-auto block object-cover"
                    onerror="this.onerror=null; this.src='https://placehold.co/' + width + 'x' + height + '/3B82F6/FFFFFF?text=IMAGE+ERROR';"
                >
            </div>
        {% endif %}
    {% else %}
        <!-- メディアがない場合のプレースホルダー -->
        <div class="media-container bg-gray-100 p-8 rounded-xl shadow-inner text-center text-gray-500 mx-auto"
             style="max-width: {{ width }}px;">
            <i class="fas fa-exclamation-circle text-xl mr-2"></i> 関連メディアが見つかりません。
        </div>
    {% endif %}
{% endmacro %}
