{% extends "base.html" %}

{% block title %}投稿の編集: {{ post.title }}{% endblock %}

{% block content %}

<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family: "Inter", sans-serif; }
/* モーダル表示中は背景スクロールを禁止 */
.modal-open { overflow: hidden; }
</style>

<div class="min-h-screen bg-gray-100 p-4 sm:p-8">
<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
<h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">
<i class="fas fa-edit text-indigo-500 mr-2"></i> 投稿の編集
</h1>
<p class="text-sm text-gray-500 mb-6">既存の投稿内容（「{{ post.title }}」）を変更し、更新します。</p>

    <!-- 編集フォーム -->
    <form id="postForm" class="space-y-6" action="{{ url_for('update', post_id=post.id) }}" method="POST" enctype="multipart/form-data">
        
        <!-- 1. CSRFトークンの埋め込み (重要!) -->
        {% if form %}
            {{ form.hidden_tag() }}
        {% endif %}
        
        <!-- タイトル入力 -->
        <div>
            <label for="title" class="block text-lg font-medium text-gray-700 mb-2">タイトル</label>
            {% if form and form.title.errors %}
            <ul class="text-red-500 text-sm mb-1 space-y-1">
                {% for error in form.title.errors %}<li class="flex items-center"><i class="fas fa-exclamation-circle mr-1"></i> {{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
            <!-- form.title.data があれば優先（バリデーション失敗時）、なければ post.title を使用 -->
            <input type="text" id="title" name="title" required
                    class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base"
                    placeholder="魅力的なタイトルを入力してください"
                    value="{{ form.title.data if form and form.title.data is not none else post.title if post.title is not none else '' }}">
        </div>

        <!-- 本文入力 -->
        <div>
            <label for="content" class="block text-lg font-medium text-gray-700 mb-2">本文</label>
            
            {% if form and form.content.errors %}
            <ul class="text-red-500 text-sm mb-1 space-y-1">
                <!-- content フィールドのエラーを表示 -->
                {% for error in form.content.errors %}<li class="flex items-center"><i class="fas fa-exclamation-circle mr-1"></i> {{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
            
            <textarea id="content" name="content" rows="10" required
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base resize-y"
                        placeholder="投稿の本文を記述してください。">
                        
                        {{ form.content.data if form and form.content.data is not none else post.content if post.content is not none else '' }}
                        
            </textarea>
        </div>
        
        <!-- 画像ファイル入力 (既存の画像表示と新規アップロード) -->
        <div>
            <label class="block text-lg font-medium text-gray-700 mb-2">現在の画像</label>
            
            {% if post.image_url %}
            <div id="current-image-container" class="mb-4">
                <img id="current-image" src="{{ post.image_url }}" alt="現在の画像" 
                     class="max-w-full h-auto rounded-lg shadow-md border border-gray-200 object-cover" 
                     style="max-height: 200px;">
                <p class="text-xs text-gray-500 mt-1">画像をアップロードすると、現在の画像が置き換えられます。</p>
            </div>
            {% else %}
            <p class="text-sm text-gray-500 mb-2">現在、画像は設定されていません。</p>
            {% endif %}

            <label for="image" class="block text-lg font-medium text-gray-700 mb-2">新しい画像の選択 (オプション)</label>
            <input type="file" id="image" name="image" accept="image/*"
                    class="block w-full text-sm text-gray-600
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-indigo-50 file:text-indigo-700
                            hover:file:bg-indigo-100 cursor-pointer">
            
            <!-- 新しい画像のプレビューエリア -->
            <div id="image-preview-container" class="mt-4 hidden">
                <p class="text-sm font-medium text-gray-500 mb-2">新しい画像のプレビュー:</p>
                <img id="image-preview" src="#" alt="New Image Preview" class="max-w-full h-auto rounded-lg shadow-md border border-gray-200 object-cover" style="max-height: 300px;">
            </div>
        </div>
        
        <!-- 送信ボタンとアクションボタン -->
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t border-gray-200">
            <!-- 変更を保存ボタン -->
            <button type="submit" id="submitButton"
                    class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                <i class="fas fa-save mr-2"></i> 変更を保存
            </button>
            
            <!-- 記事を削除ボタン (モーダルをトリガー) -->
            <button type="button" id="openDeleteModalButton"
                    class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                <i class="fas fa-trash-alt mr-2"></i> 記事を削除
            </button>

            <!-- ダッシュボードに戻るリンク -->
            <a href="{{ url_for('admin') }}"
                class="flex-1 flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-lg text-lg font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                <i class="fas fa-arrow-left mr-2"></i> ダッシュボードに戻る
            </a>
        </div>

    </form>
</div>
</div>

<!-- 記事削除確認モーダル (アラート/確認ダイアログの代替) -->
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 overflow-y-auto h-full w-full z-50 flex items-center justify-center transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white rounded-xl p-6 md:p-8 max-w-lg w-11/12 mx-auto shadow-2xl transform transition-transform duration-300 scale-95">
        <h3 id="modal-title" class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">
            <i class="fas fa-exclamation-triangle mr-2"></i> 削除の最終確認
        </h3>
        <p class="text-gray-700 mb-6">
            本当にこの記事「<span class="font-semibold">{{ post.title }}</span>」を削除してもよろしいですか？<br>
            **この操作は元に戻せません。**
        </p>
        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
            <!-- キャンセルボタン -->
            <button id="cancelDeleteButton" type="button" 
                    class="order-2 sm:order-1 py-3 px-6 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out">
                キャンセル
            </button>
            
            <!-- 削除実行フォーム (POSTリクエストを送信) -->
            <form action="{{ url_for('delete', post_id=post.id) }}" method="POST" class="order-1 sm:order-2 w-full sm:w-auto">
              {% if form %}
              {{ form.hidden_tag() }}
    　　　　　 {% endif %}
                <button type="submit" 
                        class="w-full py-3 px-6 rounded-lg text-white bg-red-600 hover:bg-red-700 font-semibold shadow-md transition duration-150 ease-in-out">
                    はい、完全に削除します
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const currentImageContainer = document.getElementById('current-image-container');

    const openModalButton = document.getElementById('openDeleteModalButton');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const body = document.body;

    // --- 画像プレビュー機能 ---
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                // 新規画像が選択された場合、既存の画像を非表示にする
                if(currentImageContainer) currentImageContainer.style.display = 'none';
            }
            reader.readAsDataURL(file);
        } else {
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            // 新規画像がキャンセルされた場合、既存の画像を再表示する
            if(currentImageContainer) currentImageContainer.style.display = 'block';
        }
    });

    // --- 削除モーダル機能 ---

    // モーダルを開く
    openModalButton.addEventListener('click', () => {
        deleteModal.classList.remove('hidden');
        body.classList.add('modal-open');
    });

    // モーダルを閉じる
    const closeModal = () => {
        deleteModal.classList.add('hidden');
        body.classList.remove('modal-open');
    };

    // キャンセルボタンで閉じる
    cancelDeleteButton.addEventListener('click', closeModal);

    // モーダル外のクリックで閉じる
    deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
            closeModal();
        }
    });

    // ESCキーで閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteModal.classList.contains('hidden')) {
            closeModal();
        }
    });
});
</script>
{% endblock %}
